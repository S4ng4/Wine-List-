<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Italian Wine List - Interactive Dashboard</title>
<style>
  /* Basic theme inspired by your Tailwind dark UI */
  :root{
    --bg:#000;
    --panel:#0f1112;
    --muted:#9a9a9a;
    --border:#2b2b2b;
    --accent:#c28500; /* amber-like */
    --card:#121212;
    --glass: rgba(255,255,255,0.03);
    --text:#eee;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;line-height:1.3}
  .container{max-width:1120px;margin:0 auto;padding:20px;}
  /* Mobile header */
  .mobile-header{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg);z-index:40}
  .brand{display:flex;align-items:center;gap:8px}
  .brand .logo{width:24px;height:24px;background:linear-gradient(180deg,var(--accent),#f3bf59);border-radius:6px;display:inline-block}
  .btn-icon{background:#111;padding:8px;border-radius:8px;border:1px solid var(--border);color:var(--muted);cursor:pointer}
  .btn-icon:hover{color:var(--text)}
  /* root layout */
  .flex{display:flex;gap:16px}
  .sidebar{width:320px;background:var(--panel);border-right:1px solid var(--border);height:calc(100vh - 0px);overflow:auto;padding:20px;position:sticky;top:0}
  .sidebar.collapsed{transform:translateX(-110%);position:fixed;left:0;top:0;height:100vh;z-index:60;transition:transform .25s ease}
  .sidebar .section{margin-bottom:18px}
  .muted{color:var(--muted);font-size:12px}
  .stat{background:var(--card);padding:14px;border-radius:10px;border:1px solid var(--border);text-align:center}
  input[type=number],select,input[type=text]{background:transparent;border:1px solid var(--border);padding:8px;border-radius:8px;color:var(--text);outline:none;width:100%}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{padding:7px 12px;border-radius:999px;background:transparent;border:1px solid var(--border);color:var(--muted);cursor:pointer}
  .chip.active{background:var(--accent);color:#000;border:1px solid rgba(0,0,0,0.2)}
  /* main */
  .main{flex:1;overflow:auto;padding:20px 8px}
  .search-circle{display:flex;justify-content:center;margin-bottom:28px}
  .search-box{width:100%;max-width:420px;background:linear-gradient(180deg,#0a0a0a, #040404);border-radius:999px;padding:20px;border:1px solid var(--border);text-align:center;position:relative}
  .search-box input{background:transparent;border:none;font-size:20px;text-align:center;color:var(--text);width:100%}
  .favorites{background:var(--panel);padding:14px;border-radius:14px;border:1px solid var(--border);margin-bottom:18px}
  .favorites .fav-list{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
  .fav-pill{padding:8px 12px;border-radius:999px;background:#0b0b0b;border:1px solid var(--border);color:var(--muted)}
  .controls{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap}
  .controls .group{display:flex;gap:8px;align-items:center}
  .view-toggle button{padding:8px;border-radius:8px;border:1px solid var(--border);background:#0b0b0b;color:var(--muted);cursor:pointer}
  .view-toggle button.active{background:var(--accent);color:#000;border:1px solid rgba(0,0,0,0.15)}
  /* grid cards */
  .grid{display:grid;grid-template-columns:repeat(1,1fr);gap:12px}
  @media(min-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media(min-width:1024px){.grid{grid-template-columns:repeat(3,1fr)}}
  .card{background:var(--panel);padding:16px;border-radius:12px;border:1px solid var(--border);position:relative;overflow:hidden}
  .card .accent{position:absolute;left:0;top:0;bottom:0;width:6px;border-radius:0 6px 6px 0;background:linear-gradient(180deg,var(--accent),#f3bf59);opacity:.6}
  .card h3{margin:0 0 8px 0;font-weight:400}
  .card .price{font-size:18px;color:var(--accent);font-weight:400}
  .meta{font-size:13px;color:var(--muted)}
  /* table */
  .table-wrap{background:var(--panel);border-radius:10px;border:1px solid var(--border);overflow:auto}
  table{width:100%;border-collapse:collapse}
  th,td{padding:12px;text-align:left;font-size:14px;border-bottom:1px solid var(--border);color:var(--muted)}
  th{background:#070707;color:var(--muted);text-transform:uppercase;font-size:12px}
  tr:hover td{background:#050505}
  .pagination{display:flex;gap:8px;justify-content:center;margin-top:16px;flex-wrap:wrap}
  .pag-btn{padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:#0b0b0b;color:var(--muted);cursor:pointer}
  .pag-btn.active{background:var(--accent);color:#000}
  .no-results{text-align:center;padding:40px;color:var(--muted)}
  /* overlay for mobile sidebar */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:50}
  /* small tweaks */
  .small{font-size:12px;color:var(--muted)}
  .reset{background:none;border:none;color:var(--muted);cursor:pointer;padding:6px}
  .hide-on-mobile{display:none}
  @media(min-width:1024px){.hide-on-mobile{display:block}}
  
  /* Mobile-First Filter Dropdowns */
  .dropdown-btn:hover{background:var(--accent);color:#000;border-color:var(--accent);transform:translateY(-1px)}
  .dropdown-btn.active{background:var(--accent);color:#000;border-color:var(--accent)}
  .dropdown-btn.active:hover{background:#f3bf59;transform:translateY(-1px)}
  .dropdown-btn.active .dropdown-arrow{transform:rotate(180deg)}
  
  .dropdown-menu{box-shadow:0 8px 24px rgba(0,0,0,0.3);border:1px solid var(--border)}
  .dropdown-option{padding:12px 16px;cursor:pointer;border-bottom:1px solid var(--border);transition:background 0.2s ease;font-size:14px;color:var(--text)}
  .dropdown-option:hover{background:var(--glass)}
  .dropdown-option:last-child{border-bottom:none}
  .dropdown-option.active{background:var(--accent);color:#000}
  
  /* Quick filter chips */
  .quick-filter-chip:hover{background:var(--accent);color:#000;border-color:var(--accent);transform:translateY(-1px)}
  .quick-filter-chip.active{background:var(--accent);color:#000;border-color:var(--accent)}
  
  /* Category buttons in sidebar */
  .category-btn:hover{background:var(--accent);color:#000;border-color:var(--accent);transform:translateY(-1px)}
  .category-btn.active{background:var(--accent);color:#000;border-color:var(--accent)}
  .category-btn.active:hover{background:#f3bf59}
  
  /* Mobile-first responsive adjustments */
  @media (max-width: 768px) {
    .mobile-filters{margin-bottom:16px}
    .filter-row{grid-template-columns:1fr;gap:8px}
    .dropdown-btn{min-height:44px;padding:12px}
    .quick-filters{justify-content:flex-start;gap:6px}
    .quick-filter-chip{padding:6px 12px;font-size:11px}
  }
  
  @media (min-width: 769px) {
    .mobile-filters{display:block}
  }
</style>
</head>
<body>
<div class="mobile-header hide-on-mobile">
  <!-- empty - desktop doesn't need this -->
</div>

<div class="mobile-header" id="mobileHeader">
  <div class="brand"><span class="logo" aria-hidden></span><div style="font-weight:300">Italian Wines</div></div>
  <div style="display:flex;gap:8px;align-items:center">
    <button class="btn-icon" id="sidebarToggle" aria-label="Toggle sidebar">‚ò∞</button>
  </div>
</div>

<div class="flex container" style="align-items:flex-start">
  <!-- Sidebar -->
  <aside id="sidebar" class="sidebar">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
      <div style="display:flex;gap:8px;align-items:center"><span class="logo" style="width:28px;height:28px"></span><h2 style="margin:0;font-weight:300">Italian Wines</h2></div>
      <button id="closeSidebar" class="btn-icon" title="Close">‚úï</button>
    </div>

    <div class="section">
      <div class="stat"><div style="font-size:20px;font-weight:300" id="statCount">0</div><div class="small">Wines Found</div></div>
    </div>

    <!-- Wine Category Buttons for Non-Pro Users -->
    <div class="section">
      <label class="small">Wine Categories</label>
      <div class="category-buttons" style="margin-top:12px;display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
        <button class="category-btn" data-type="all" style="padding:12px 8px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer;transition:all 0.2s ease;font-size:12px;font-weight:500;display:flex;flex-direction:column;align-items:center;gap:4px">
          <span style="font-size:16px">üç∑</span>
          <span>All Wines</span>
        </button>
        <button class="category-btn" data-type="Red" style="padding:12px 8px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer;transition:all 0.2s ease;font-size:12px;font-weight:500;display:flex;flex-direction:column;align-items:center;gap:4px">
          <span style="font-size:16px">üç∑</span>
          <span>Red</span>
        </button>
        <button class="category-btn" data-type="White" style="padding:12px 8px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer;transition:all 0.2s ease;font-size:12px;font-weight:500;display:flex;flex-direction:column;align-items:center;gap:4px">
          <span style="font-size:16px">ü•Ç</span>
          <span>White</span>
        </button>
        <button class="category-btn" data-type="Rose" style="padding:12px 8px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer;transition:all 0.2s ease;font-size:12px;font-weight:500;display:flex;flex-direction:column;align-items:center;gap:4px">
          <span style="font-size:16px">üåπ</span>
          <span>Rose</span>
        </button>
        <button class="category-btn" data-type="Sparkling" style="padding:12px 8px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer;transition:all 0.2s ease;font-size:12px;font-weight:500;display:flex;flex-direction:column;align-items:center;gap:4px">
          <span style="font-size:16px">üçæ</span>
          <span>Sparkling</span>
        </button>
        <button class="category-btn" data-type="Orange" style="padding:12px 8px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer;transition:all 0.2s ease;font-size:12px;font-weight:500;display:flex;flex-direction:column;align-items:center;gap:4px">
          <span style="font-size:16px">üçä</span>
          <span>Orange</span>
        </button>
      </div>
    </div>

    <div class="section">
      <label class="small">Price Range</label>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="priceMin" type="number" min="0" value="0" />
        <input id="priceMax" type="number" min="0" value="1000" />
      </div>
      <div class="small" style="margin-top:8px" id="priceLabel">‚Ç¨0 - ‚Ç¨1000</div>
    </div>

    <div class="section">
      <label class="small">Classification</label>
      <div class="chips" id="classChips" style="margin-top:8px"></div>
    </div>

    <div class="section">
      <label class="small">Region</label>
      <select id="regionSelect" style="margin-top:8px"></select>
    </div>

    <div class="section">
      <label class="small">Producer</label>
      <select id="varietalSelect" style="margin-top:8px"></select>
    </div>

    <div class="section">
      <button id="resetBtn" class="reset">Reset All Filters</button>
    </div>

  </aside>

  <!-- Main -->
  <main class="main">
    <div class="search-circle">
      <div class="search-box">
        <div style="display:flex;flex-direction:column;align-items:center;gap:8px;max-width:320px">
          <div style="display:flex;gap:6px;align-items:center;color:var(--muted)">
            <span>üîç</span><span style="color:var(--accent)">üç∑</span>
          </div>
          <input id="searchInput" type="text" placeholder="Search wines..." />
          <div class="small" style="margin-top:8px">Fuzzy Search Ready</div>
        </div>
      </div>
    </div>

    <!-- Mobile-First Filter Dropdowns -->
    <div class="mobile-filters" style="margin-bottom:24px">
      <div class="filter-row" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
        <div class="dropdown-container" style="position:relative">
          <button id="regionDropdownBtn" class="dropdown-btn" style="width:100%;padding:16px;border-radius:12px;border:1px solid var(--border);background:var(--panel);color:var(--text);cursor:pointer;transition:all 0.2s ease;font-size:14px;font-weight:500;display:flex;align-items:center;justify-content:space-between;min-height:48px">
            <span style="display:flex;align-items:center;gap:8px">
              <span style="font-size:16px">üó∫Ô∏è</span>
              <span id="regionBtnText">Region</span>
            </span>
            <span class="dropdown-arrow" style="transition:transform 0.2s ease">‚ñº</span>
          </button>
          <div id="regionDropdown" class="dropdown-menu" style="position:absolute;top:100%;left:0;right:0;background:var(--panel);border:1px solid var(--border);border-radius:12px;margin-top:4px;z-index:100;max-height:200px;overflow-y:auto;display:none;box-shadow:0 8px 24px rgba(0,0,0,0.3)">
            <!-- Options will be populated by JS -->
          </div>
        </div>
        
        <div class="dropdown-container" style="position:relative">
          <button id="varietalDropdownBtn" class="dropdown-btn" style="width:100%;padding:16px;border-radius:12px;border:1px solid var(--border);background:var(--panel);color:var(--text);cursor:pointer;transition:all 0.2s ease;font-size:14px;font-weight:500;display:flex;align-items:center;justify-content:space-between;min-height:48px">
            <span style="display:flex;align-items:center;gap:8px">
              <span style="font-size:16px">üçá</span>
              <span id="varietalBtnText">Producer</span>
            </span>
            <span class="dropdown-arrow" style="transition:transform 0.2s ease">‚ñº</span>
          </button>
          <div id="varietalDropdown" class="dropdown-menu" style="position:absolute;top:100%;left:0;right:0;background:var(--panel);border:1px solid var(--border);border-radius:12px;margin-top:4px;z-index:100;max-height:200px;overflow-y:auto;display:none;box-shadow:0 8px 24px rgba(0,0,0,0.3)">
            <!-- Options will be populated by JS -->
          </div>
        </div>
      </div>
      
      <!-- Quick filter chips for mobile -->
      <div class="quick-filters" style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
        <button class="quick-filter-chip" data-filter="price-low" style="padding:8px 16px;border-radius:20px;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer;font-size:12px;transition:all 0.2s ease">
          üí∞ Under ‚Ç¨30
        </button>
        <button class="quick-filter-chip" data-filter="favorites" style="padding:8px 16px;border-radius:20px;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer;font-size:12px;transition:all 0.2s ease">
          ‚≠ê Featured
        </button>
        <button class="quick-filter-chip" data-filter="docg" style="padding:8px 16px;border-radius:20px;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer;font-size:12px;transition:all 0.2s ease">
          üèÜ DOCG
        </button>
      </div>
    </div>

    <section class="favorites">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;color:var(--muted)"><span>‚ú®</span><div class="small">Featured Wines</div></div>
      <div class="fav-list" id="favList"></div>
    </section>

    <div class="controls">
      <div class="group small" id="countInfo">Showing 0 of 0 wines</div>
      <div class="group view-toggle">
        <button id="cardViewBtn" class="active" title="Card view">‚ñ¶</button>
        <button id="tableViewBtn" title="Table view">‚â°</button>
      </div>
    </div>

    <!-- Results area -->
    <div id="resultsArea">
      <!-- cards go here -->
      <div id="cardsGrid" class="grid"></div>

      <!-- table -->
      <div id="tableWrap" class="table-wrap" style="display:none;margin-top:8px">
        <table>
          <thead>
            <tr>
              <th>Wine</th>
              <th class="hide-on-mobile">Class</th>
              <th class="hide-on-mobile">Region</th>
              <th class="hide-on-mobile">Producer</th>
              <th style="text-align:right">Price</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <div class="no-results" id="noResults" style="display:none">
        <div style="font-size:40px;opacity:.2">üç∑</div>
        <div class="small">No wines match your filters</div>
        <div class="small" style="margin-top:6px">Try adjusting your search</div>
      </div>

      <div class="pagination" id="pagination"></div>
    </div>
  </main>
</div>

<div id="overlay" class="overlay" style="display:none"></div>

<script>
/* Data and initial state */
let wines = []; // Will be loaded from JSON

// Wine type mapping from JSON to our categories
function mapWineType(jsonWineType) {
  const typeMap = {
    'ROSSO': 'Red',
    'BIANCO': 'White', 
    'ROSATO': 'Rose',
    'BOLLICINE': 'Sparkling',
    'CHIANTI': 'Red',
    'MONTALCINO': 'Red',
    'AMARONE': 'Red',
    'BAROLO DOCG': 'Red',
    'SUPERTUSCAN/BOLGHERI': 'Red'
  };
  return typeMap[jsonWineType] || 'N/A';
}

// Function to load wines from JSON
async function loadWinesFromJSON() {
  try {
    const response = await fetch('data/wines.json');
    const data = await response.json();
    
    wines = data.wines.map((wine, index) => ({
      id: index + 1,
      name: wine.wine_name,
      type: mapWineType(wine.wine_type),
      region: wine.region,
      varietal: wine.wine_producer, // Using producer as varietal for now
      classification: wine.wine_vintage.includes('DOCG') ? 'DOCG' : 
                     wine.wine_vintage.includes('DOC') ? 'DOC' : 
                     wine.wine_vintage.includes('IGT') ? 'IGT' : 'N/A',
      price: parseFloat(wine.wine_price_bottle || wine.wine_price || 0),
      year: wine.wine_vintage.match(/\d{4}/)?.[0] || 'N/A',
      producer: wine.wine_producer,
      description: wine.wine_description,
      organic: wine.organic,
      favorite: false
    }));
    
    console.log('Loaded', wines.length, 'wines from JSON');
    return wines;
  } catch (error) {
    console.error('Error loading wines:', error);
    return [];
  }
}

// Derived lists (will be updated after loading)
let regions = ['all'];
let varietals = ['all'];
let classifications = ['all', 'DOCG', 'DOC', 'IGT'];
let producers = ['all'];

// Function to update derived lists after loading wines
function updateDerivedLists() {
  regions = ['all', ...Array.from(new Set(wines.map(w => w.region)))];
  varietals = ['all', ...Array.from(new Set(wines.map(w => w.varietal)))];
  producers = ['all', ...Array.from(new Set(wines.map(w => w.producer)))];
}

// UI elements
const sidebar = document.getElementById('sidebar');
const sidebarToggle = document.getElementById('sidebarToggle');
const closeSidebar = document.getElementById('closeSidebar');
const overlay = document.getElementById('overlay');

const priceMinInput = document.getElementById('priceMin');
const priceMaxInput = document.getElementById('priceMax');
const priceLabel = document.getElementById('priceLabel');
const classChips = document.getElementById('classChips');
const regionSelect = document.getElementById('regionSelect');
const varietalSelect = document.getElementById('varietalSelect');
const resetBtn = document.getElementById('resetBtn');

// Mobile dropdown elements
const regionDropdownBtn = document.getElementById('regionDropdownBtn');
const varietalDropdownBtn = document.getElementById('varietalDropdownBtn');
const regionDropdown = document.getElementById('regionDropdown');
const varietalDropdown = document.getElementById('varietalDropdown');
const regionBtnText = document.getElementById('regionBtnText');
const varietalBtnText = document.getElementById('varietalBtnText');

const searchInput = document.getElementById('searchInput');
const favList = document.getElementById('favList');
const statCount = document.getElementById('statCount');
const countInfo = document.getElementById('countInfo');

const cardViewBtn = document.getElementById('cardViewBtn');
const tableViewBtn = document.getElementById('tableViewBtn');

const cardsGrid = document.getElementById('cardsGrid');
const tableWrap = document.getElementById('tableWrap');
const tableBody = document.getElementById('tableBody');
const paginationWrap = document.getElementById('pagination');
const noResults = document.getElementById('noResults');

// State
let searchTerm = '';
let selectedRegion = 'all';
let selectedVarietal = 'all';
let selectedClassification = 'all';
let selectedWineType = 'all'; // New state for wine type filter
let priceRange = [0,1000];
let viewMode = 'card';
let currentPage = 1;
const itemsPerPage = 20;

/* Helpers */
// fuzzy matching similar to your function
function fuzzyMatch(text = '', query = '') {
  text = String(text).toLowerCase();
  query = String(query).toLowerCase();
  if (!query) return 1;
  if (text.includes(query)) return 1;
  let score = 0;
  let qIdx = 0;
  for (let i=0;i<text.length && qIdx<query.length;i++){
    if (text[i] === query[qIdx]) { score++; qIdx++; }
  }
  return qIdx === query.length ? score / text.length : 0;
}

/* Build filter UI */
function populateSelect(selectEl, options){
  selectEl.innerHTML = '';
  options.forEach(opt => {
    const o = document.createElement('option');
    o.value = opt;
    o.textContent = (opt === 'all') ? (selectEl === regionSelect ? 'All Regions' : 'All Varietals') : opt;
    selectEl.appendChild(o);
  });
}
populateSelect(regionSelect, regions);
populateSelect(varietalSelect, varietals);

/* Class chips */
function renderClassificationChips(){
  classChips.innerHTML = '';
  classifications.forEach(c => {
    const btn = document.createElement('button');
    btn.className = 'chip' + (selectedClassification === c ? ' active' : '');
    btn.textContent = (c === 'all') ? 'All' : c;
    btn.addEventListener('click', () => {
      selectedClassification = c;
      ensurePageReset();
      renderClassificationChips();
      render();
    });
    classChips.appendChild(btn);
  });
}
renderClassificationChips();

/* Favorites */
function renderFavorites(){
  favList.innerHTML = '';
  const favs = wines.filter(w => w.favorite);
  favs.forEach(w => {
    const pill = document.createElement('div');
    pill.className = 'fav-pill';
    pill.textContent = w.name;
    favList.appendChild(pill);
  });
}
renderFavorites();

/* Filtering & results computation (useMemo equivalent) */
function computeFilteredWines(){
  let filtered = [...wines];
  if (selectedRegion !== 'all') filtered = filtered.filter(w => w.region === selectedRegion);
  if (selectedVarietal !== 'all') filtered = filtered.filter(w => w.varietal === selectedVarietal);
  if (selectedClassification !== 'all') filtered = filtered.filter(w => w.classification === selectedClassification);
  if (selectedWineType !== 'all') filtered = filtered.filter(w => w.type === selectedWineType);
  filtered = filtered.filter(w => w.price >= priceRange[0] && w.price <= priceRange[1]);

  if (!searchTerm.trim()) {
    return filtered.map(w => ({...w, score:1}));
  }

  const results = filtered.map(w => {
    const nameScore = fuzzyMatch(w.name, searchTerm) * 3;
    const regionScore = fuzzyMatch(w.region, searchTerm) * 2;
    const varietalScore = fuzzyMatch(w.varietal, searchTerm) * 2;
    const producerScore = fuzzyMatch(w.producer, searchTerm) * 2;
    const totalScore = nameScore + regionScore + varietalScore + producerScore;
    return {...w, score: totalScore};
  })
  .filter(w => w.score > 0.3)
  .sort((a,b) => b.score - a.score);

  return results;
}

/* Pagination helpers */
function getPaginated(list){
  const totalPages = Math.ceil(list.length / itemsPerPage) || 1;
  if (currentPage > totalPages) currentPage = totalPages;
  const start = (currentPage - 1) * itemsPerPage;
  return { paginated: list.slice(start, start + itemsPerPage), totalPages };
}

/* Render functions */
function renderCards(list){
  cardsGrid.innerHTML = '';
  list.forEach(wine => {
    const div = document.createElement('div');
    div.className = 'card';
    const accent = document.createElement('div'); accent.className = 'accent';
    accent.style.opacity = Math.max(0.3, Math.min(1, wine.score || 1));
    div.appendChild(accent);

    const title = document.createElement('h3'); title.textContent = wine.name;
    const price = document.createElement('div'); price.className = 'price'; price.textContent = `‚Ç¨${wine.price}`;
    const meta = document.createElement('div'); meta.className = 'meta';
    meta.innerHTML = `<div style="margin-bottom:6px"><span style="background:#0b0b0b;padding:4px 8px;border-radius:6px;color:var(--accent);font-weight:500">${wine.classification}</span> <span style="margin-left:8px">${wine.year}</span></div>
                      <div>${wine.varietal} ‚Ä¢ ${wine.region}</div>
                      <div style="color:var(--muted)">${wine.producer}</div>`;
    div.appendChild(title);
    div.appendChild(price);
    div.appendChild(meta);

    cardsGrid.appendChild(div);
  });
}

function renderTable(list){
  tableBody.innerHTML = '';
  list.forEach(wine => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <div style="font-weight:500;color:var(--text)">${wine.name}</div>
        <div style="font-size:12px;color:var(--muted);margin-top:4px">${wine.classification} ‚Ä¢ ${wine.region}</div>
      </td>
      <td class="hide-on-mobile" style="color:var(--accent)">${wine.classification}</td>
      <td class="hide-on-mobile" style="color:var(--muted)">${wine.region}</td>
      <td class="hide-on-mobile" style="color:var(--muted)">${wine.producer}</td>
      <td style="text-align:right;color:var(--accent);font-weight:500">‚Ç¨${wine.price}</td>
    `;
    tableBody.appendChild(tr);
  });
}

function renderPagination(totalPages){
  paginationWrap.innerHTML = '';
  if (totalPages <= 1) return;
  const prev = document.createElement('button'); prev.className='pag-btn'; prev.textContent='Previous';
  prev.disabled = currentPage === 1;
  prev.addEventListener('click', ()=>{ if(currentPage>1){ currentPage--; render(); }});
  paginationWrap.appendChild(prev);

  // show up to 5 page buttons: current chunk
  const maxButtons = Math.min(5, totalPages);
  // choose start such that currentPage is visible
  let start = Math.max(1, currentPage - 2);
  if (start + maxButtons - 1 > totalPages) start = Math.max(1, totalPages - maxButtons + 1);

  for (let i = 0; i < maxButtons; i++){
    const pageNum = start + i;
    const btn = document.createElement('button');
    btn.className = 'pag-btn' + (pageNum === currentPage ? ' active' : '');
    btn.textContent = String(pageNum);
    btn.addEventListener('click', ()=>{ currentPage = pageNum; render(); });
    paginationWrap.appendChild(btn);
  }

  const next = document.createElement('button'); next.className='pag-btn'; next.textContent='Next';
  next.disabled = currentPage === totalPages;
  next.addEventListener('click', ()=>{ if(currentPage<totalPages){ currentPage++; render(); }});
  paginationWrap.appendChild(next);
}

/* Main render pipeline */
function render(){
  // compute filtered
  const filtered = computeFilteredWines();
  statCount.textContent = filtered.length;
  countInfo.textContent = `Showing ${Math.min(filtered.length, itemsPerPage)} of ${filtered.length} wines`;

  if (filtered.length === 0){
    cardsGrid.style.display = 'none';
    tableWrap.style.display = 'none';
    noResults.style.display = 'block';
    paginationWrap.innerHTML = '';
    priceLabel.textContent = `‚Ç¨${priceRange[0]} - ‚Ç¨${priceRange[1]}`;
    return;
  } else {
    noResults.style.display = 'none';
  }

  const { paginated, totalPages } = getPaginated(filtered);
  // view
  if (viewMode === 'card'){
    cardsGrid.style.display = 'grid';
    tableWrap.style.display = 'none';
    renderCards(paginated);
  } else {
    cardsGrid.style.display = 'none';
    tableWrap.style.display = 'block';
    renderTable(paginated);
  }

  renderPagination(totalPages);
  priceLabel.textContent = `‚Ç¨${priceRange[0]} - ‚Ç¨${priceRange[1]}`;
}

/* Mobile dropdown functions */
function populateDropdowns() {
  // Populate region dropdown
  regionDropdown.innerHTML = '';
  regions.forEach(region => {
    const option = document.createElement('div');
    option.className = 'dropdown-option';
    option.textContent = region === 'all' ? 'All Regions' : region;
    option.dataset.value = region;
    if (region === selectedRegion) option.classList.add('active');
    
    option.addEventListener('click', () => {
      selectedRegion = region;
      regionSelect.value = region;
      updateMobileFilterStates();
      closeAllDropdowns();
      ensurePageReset();
      render();
    });
    
    regionDropdown.appendChild(option);
  });
  
  // Populate varietal dropdown
  varietalDropdown.innerHTML = '';
  varietals.forEach(varietal => {
    const option = document.createElement('div');
    option.className = 'dropdown-option';
    option.textContent = varietal === 'all' ? 'All Producers' : varietal;
    option.dataset.value = varietal;
    if (varietal === selectedVarietal) option.classList.add('active');
    
    option.addEventListener('click', () => {
      selectedVarietal = varietal;
      varietalSelect.value = varietal;
      updateMobileFilterStates();
      closeAllDropdowns();
      ensurePageReset();
      render();
    });
    
    varietalDropdown.appendChild(option);
  });
}

function updateMobileFilterStates() {
  // Update region dropdown button
  if (selectedRegion === 'all') {
    regionDropdownBtn.classList.remove('active');
    regionBtnText.textContent = 'Region';
  } else {
    regionDropdownBtn.classList.add('active');
    regionBtnText.textContent = selectedRegion;
  }
  
  // Update varietal dropdown button
  if (selectedVarietal === 'all') {
    varietalDropdownBtn.classList.remove('active');
    varietalBtnText.textContent = 'Producer';
  } else {
    varietalDropdownBtn.classList.add('active');
    varietalBtnText.textContent = selectedVarietal;
  }
}

function closeAllDropdowns() {
  regionDropdown.style.display = 'none';
  varietalDropdown.style.display = 'none';
  regionDropdownBtn.classList.remove('active');
  varietalDropdownBtn.classList.remove('active');
}

function toggleDropdown(dropdown, button) {
  const isOpen = dropdown.style.display === 'block';
  closeAllDropdowns();
  
  if (!isOpen) {
    dropdown.style.display = 'block';
    button.classList.add('active');
  }
}

/* Event wiring */
searchInput.addEventListener('input', (e) => {
  searchTerm = e.target.value;
  ensurePageReset();
  render();
});

priceMinInput.addEventListener('change', (e) => {
  priceRange[0] = Number(e.target.value) || 0;
  if (priceRange[0] > priceRange[1]) priceRange[1] = priceRange[0];
  ensurePageReset();
  render();
});
priceMaxInput.addEventListener('change', (e) => {
  priceRange[1] = Number(e.target.value) || 1000;
  if (priceRange[1] < priceRange[0]) priceRange[0] = priceRange[1];
  ensurePageReset();
  render();
});

regionSelect.addEventListener('change', (e) => {
  selectedRegion = e.target.value;
  updateMobileFilterStates();
  populateDropdowns();
  ensurePageReset();
  render();
});
varietalSelect.addEventListener('change', (e) => {
  selectedVarietal = e.target.value;
  updateMobileFilterStates();
  populateDropdowns();
  ensurePageReset();
  render();
});

// Mobile dropdown event listeners
regionDropdownBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  toggleDropdown(regionDropdown, regionDropdownBtn);
});

varietalDropdownBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  toggleDropdown(varietalDropdown, varietalDropdownBtn);
});

// Category buttons in sidebar - initialize after DOM is ready
function initCategoryButtons() {
  document.querySelectorAll('.category-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const type = btn.dataset.type;
      const filter = btn.dataset.filter;
      
      // Remove active state from all category buttons
      document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
    // Apply category filters
    if (type) {
      selectedWineType = type;
    }
      
      updateMobileFilterStates();
      populateDropdowns();
      renderClassificationChips();
  ensurePageReset();
  render();
});
  });
}

// Quick filter chips - initialize after DOM is ready
function initQuickFilterChips() {
  document.querySelectorAll('.quick-filter-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      const filter = chip.dataset.filter;
      
      // Remove active state from all chips
      document.querySelectorAll('.quick-filter-chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      
      // Apply quick filters
      switch(filter) {
        case 'price-low':
          priceRange = [0, 30];
          priceMinInput.value = 0;
          priceMaxInput.value = 30;
          break;
        case 'favorites':
          // Filter to show only favorites
          const favWines = wines.filter(w => w.favorite);
          break;
        case 'docg':
          selectedClassification = 'DOCG';
          break;
      }
      
      updateMobileFilterStates();
      populateDropdowns();
  ensurePageReset();
  render();
});
  });
}
resetBtn.addEventListener('click', () => {
  selectedRegion = 'all';
  selectedVarietal = 'all';
  selectedClassification = 'all';
  selectedWineType = 'all';
  priceRange = [0,1000];
  searchTerm = '';
  currentPage = 1;
  // UI sync
  priceMinInput.value = priceRange[0];
  priceMaxInput.value = priceRange[1];
  searchInput.value = '';
  regionSelect.value = 'all';
  varietalSelect.value = 'all';
  
  // Reset all filter buttons and chips
  document.querySelectorAll('.quick-filter-chip').forEach(c => c.classList.remove('active'));
  document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
  // Activate "All Wines" button by default (with safety check)
  const allWinesBtn = document.querySelector('[data-type="all"]');
  if (allWinesBtn) {
    allWinesBtn.classList.add('active');
  }
  
  updateMobileFilterStates();
  populateDropdowns();
  closeAllDropdowns();
  renderClassificationChips();
  render();
});

/* View toggle */
cardViewBtn.addEventListener('click', () => { viewMode = 'card'; cardViewBtn.classList.add('active'); tableViewBtn.classList.remove('active'); render(); });
tableViewBtn.addEventListener('click', () => { viewMode = 'table'; tableViewBtn.classList.add('active'); cardViewBtn.classList.remove('active'); render(); });

/* Sidebar mobile toggle */
sidebarToggle.addEventListener('click', ()=> {
  sidebar.classList.toggle('collapsed');
  overlay.style.display = sidebar.classList.contains('collapsed') ? 'none' : 'block';
});
closeSidebar.addEventListener('click', ()=> {
  sidebar.classList.add('collapsed');
  overlay.style.display = 'none';
});
overlay.addEventListener('click', ()=> {
  sidebar.classList.add('collapsed');
  overlay.style.display = 'none';
});

/* Reset page when filters change */
function ensurePageReset(){
  currentPage = 1;
}

/* Initialize UI default values and render first time */
async function init(){
  // Load wines from JSON first
  await loadWinesFromJSON();
  updateDerivedLists();
  
  // start collapsed on small screens
  if (window.innerWidth < 1024){
    sidebar.classList.add('collapsed');
  }
  // fill classification chips state already handled
  renderClassificationChips();
  // set selects default
  regionSelect.value = 'all';
  varietalSelect.value = 'all';
  priceMinInput.value = priceRange[0];
  priceMaxInput.value = priceRange[1];
  searchInput.value = '';
  
  // Initialize mobile dropdowns
  populateDropdowns();
  updateMobileFilterStates();
  closeAllDropdowns();
  
  // Initialize button event listeners
  initCategoryButtons();
  initQuickFilterChips();
  
  // Activate "All Wines" button by default (with safety check)
  const allWinesBtn = document.querySelector('[data-type="all"]');
  if (allWinesBtn) {
    allWinesBtn.classList.add('active');
  }
  
  render();
}

// Start initialization
init();

/* Ensure layout updates on resize: hide overlay if sidebar not visible */
window.addEventListener('resize', ()=> {
  if (window.innerWidth >= 1024){
    sidebar.classList.remove('collapsed');
    overlay.style.display = 'none';
  } else {
    if (!sidebar.classList.contains('collapsed')) overlay.style.display = 'block';
  }
});

/* Close dropdowns when clicking outside */
document.addEventListener('click', (e) => {
  if (!e.target.closest('.dropdown-container')) {
    closeAllDropdowns();
  }
});

/* Close dropdowns on escape key */
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeAllDropdowns();
  }
});
</script>
</body>
</html>
